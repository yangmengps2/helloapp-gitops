name: Auto PR dev -> main

on:
  push:
    branches: [ "dev" ]

permissions:
  contents: read

concurrency:
  group: auto-pr-dev-to-main
  cancel-in-progress: false

jobs:
  open_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Create or reuse PR (dev -> main)
        uses: actions/github-script@v7
        env:
          TOKEN: ${{ secrets.PR_BOT_TOKEN }}
        with:
          github-token: ${{ secrets.PR_BOT_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head = "dev";
            const base = "main";

            // 1) Check if an open PR already exists
            const prs = await github.rest.pulls.list({
              owner, repo, state: "open", head: `${owner}:${head}`, base
            });

            if (prs.data.length > 0) {
              core.info(`Open PR already exists: #${prs.data[0].number} ${prs.data[0].html_url}`);
              return;
            }

            // 2) Create a new PR
            const sha = context.sha.substring(0, 7);
            const title = `chore(image): promote ${head} -> ${base} (${sha})`;
            const body = [
              "Automated PR created from updates pushed to `dev`.",
              "",
              `- Source: \`${head}\``,
              `- Target: \`${base}\``,
              `- Trigger commit: \`${context.sha}\``,
              "",
              "Merge this PR to deploy the new image via Argo CD."
            ].join("\n");

            const pr = await github.rest.pulls.create({
              owner, repo, head, base, title, body
            });

            core.info(`Created PR: #${pr.data.number} ${pr.data.html_url}`);
